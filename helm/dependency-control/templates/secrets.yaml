{{/*
Application Secrets
Automatically generates secrets if not provided.
Preserves existing secrets on upgrades using lookup.
*/}}
{{- if ne .Values.secrets.provider "external-secrets" }}
{{- $secretName := printf "%s-secrets" (include "dependency-control.fullname" .) }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}

{{- /* Determine secret values - prefer existing, then provided, then generate */ -}}
{{- $secretKey := "" }}
{{- if and $existingSecret $existingSecret.data }}
  {{- $secretKey = index $existingSecret.data "secret-key" | b64dec | default "" }}
{{- end }}
{{- if and (not $secretKey) .Values.backend.secrets.secretKey }}
  {{- $secretKey = .Values.backend.secrets.secretKey }}
{{- end }}
{{- if not $secretKey }}
  {{- $secretKey = randAlphaNum 64 }}
{{- end }}

{{- /* Get Dragonfly password - lookup existing or generate */ -}}
{{- $dragonflySecretName := printf "%s-dragonfly-password" (include "dependency-control.fullname" .) }}
{{- $existingDragonflySecret := lookup "v1" "Secret" .Release.Namespace $dragonflySecretName }}
{{- $dragonflyPassword := "" }}
{{- if and $existingDragonflySecret $existingDragonflySecret.data }}
  {{- $dragonflyPassword = index $existingDragonflySecret.data "password" | b64dec | default "" }}
{{- end }}
{{- if and (not $dragonflyPassword) .Values.dragonfly.password }}
  {{- $dragonflyPassword = .Values.dragonfly.password }}
{{- end }}
{{- if not $dragonflyPassword }}
  {{- $dragonflyPassword = randAlphaNum 32 }}
{{- end }}

{{- /* Get Database app user password - lookup existing or generate - SINGLE SOURCE OF TRUTH */ -}}
{{- $appUserSecretName := printf "%s-app-user" .Values.database.cluster.name }}
{{- $existingAppUserSecret := lookup "v1" "Secret" .Release.Namespace $appUserSecretName }}
{{- $dbPassword := "" }}
{{- if and $existingAppUserSecret $existingAppUserSecret.data }}
  {{- $dbPassword = index $existingAppUserSecret.data "password" | b64dec | default "" }}
{{- end }}
{{- if and (not $dbPassword) .Values.database.auth.password }}
  {{- $dbPassword = .Values.database.auth.password }}
{{- end }}
{{- if not $dbPassword }}
  {{- $dbPassword = randAlphaNum 32 }}
{{- end }}

{{- /* Build MongoDB URL with resolved password */ -}}
{{- $caPath := printf "%s/ca.crt" .Values.global.tls.caMountPath -}}
{{- $mongodbUrl := "" }}
{{- if eq .Values.database.type "percona" -}}
  {{- $mongodbUrl = printf "mongodb://%s:%s@%s-%s.%s.svc.cluster.local:27017/%s?replicaSet=%s" .Values.database.auth.username $dbPassword .Values.database.cluster.name .Values.database.percona.replicaSetName .Release.Namespace .Values.database.auth.database .Values.database.percona.replicaSetName }}
  {{- if .Values.global.tls.enabled }}
    {{- $mongodbUrl = printf "%s&tls=true&tlsCAFile=%s&tlsCertificateKeyFile=/app/mongodb-tls/client.pem" $mongodbUrl $caPath }}
  {{- end }}
{{- else -}}
  {{- $mongodbUrl = printf "mongodb://%s:%s@%s-svc.%s.svc.cluster.local:27017/%s?replicaSet=%s" .Values.database.auth.username $dbPassword .Values.database.cluster.name .Release.Namespace .Values.database.auth.database .Values.database.cluster.name }}
  {{- if .Values.global.tls.enabled }}
    {{- $mongodbUrl = printf "%s&tls=true&tlsCAFile=%s" $mongodbUrl $caPath }}
  {{- end }}
{{- end }}

{{- /* Build Redis URL with resolved password */ -}}
{{- $redisUrl := "" }}
{{- if .Values.dragonfly.enabled }}
  {{- if .Values.global.tls.enabled }}
    {{- /* mTLS: Include client certificate for mutual TLS authentication */ -}}
    {{- $redisUrl = printf "rediss://:%s@%s-dragonfly:%v/0?ssl_ca_certs=%s&ssl_certfile=/app/certs/tls.crt&ssl_keyfile=/app/certs/tls.key&ssl_cert_reqs=required" $dragonflyPassword .Release.Name (int .Values.dragonfly.service.port) $caPath }}
  {{- else }}
    {{- $redisUrl = printf "redis://:%s@%s-dragonfly:%v/0" $dragonflyPassword .Release.Name (int .Values.dragonfly.service.port) }}
  {{- end }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
{{- if .Values.secrets.immutable }}
immutable: true
{{- end }}
type: Opaque
data:
  secret-key: {{ $secretKey | b64enc | quote }}
  mongodb-url: {{ $mongodbUrl | b64enc | quote }}
  {{- if .Values.dragonfly.enabled }}
  redis-url: {{ $redisUrl | b64enc | quote }}
  {{- end }}

{{- /* Create Database Secrets (Percona) - using the SAME $dbPassword from above */ -}}
{{- if eq .Values.database.type "percona" }}
---
{{- $dbSecretName := printf "%s-secrets" .Values.database.cluster.name }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $dbSecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
{{- if .Values.secrets.immutable }}
immutable: true
{{- end }}
type: Opaque
data:
  MONGODB_BACKUP_USER: {{ "backup" | b64enc | quote }}
  MONGODB_BACKUP_PASSWORD: {{ $dbPassword | b64enc | quote }}
  MONGODB_CLUSTER_ADMIN_USER: {{ "clusterAdmin" | b64enc | quote }}
  MONGODB_CLUSTER_ADMIN_PASSWORD: {{ $dbPassword | b64enc | quote }}
  MONGODB_CLUSTER_MONITOR_USER: {{ "clusterMonitor" | b64enc | quote }}
  MONGODB_CLUSTER_MONITOR_PASSWORD: {{ $dbPassword | b64enc | quote }}
  MONGODB_USER_ADMIN_USER: {{ "userAdmin" | b64enc | quote }}
  MONGODB_USER_ADMIN_PASSWORD: {{ $dbPassword | b64enc | quote }}
  MONGODB_DATABASE_ADMIN_USER: {{ "databaseAdmin" | b64enc | quote }}
  MONGODB_DATABASE_ADMIN_PASSWORD: {{ $dbPassword | b64enc | quote }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.database.cluster.name }}-app-user
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
{{- if .Values.secrets.immutable }}
immutable: true
{{- end }}
type: Opaque
data:
  password: {{ $dbPassword | b64enc | quote }}

---
{{/*
Database Encryption Key (Percona)
*/}}
{{- $encKeySecretName := printf "%s-encryption-key" .Values.database.cluster.name }}
{{- $existingEncKey := lookup "v1" "Secret" .Release.Namespace $encKeySecretName }}

{{- $encryptionKey := "" }}
{{- if and $existingEncKey $existingEncKey.data }}
  {{- $encryptionKey = index $existingEncKey.data "encryption-key" | b64dec | default "" }}
{{- end }}
{{- if and (not $encryptionKey) .Values.database.percona.encryptionKey }}
  {{- $encryptionKey = .Values.database.percona.encryptionKey }}
{{- end }}
{{- if not $encryptionKey }}
  {{- $encryptionKey = randAlphaNum 32 }}
{{- end }}

apiVersion: v1
kind: Secret
metadata:
  name: {{ $encKeySecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
{{- if $.Values.secrets.immutable }}
immutable: true
{{- end }}
type: Opaque
data:
  encryption-key: {{ $encryptionKey | b64enc | quote }}
{{- end }}

{{- /* Create DragonflyDB Password Secret - using the SAME $dragonflyPassword from above */ -}}
{{- if .Values.dragonfly.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $dragonflySecretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
{{- if $.Values.secrets.immutable }}
immutable: true
{{- end }}
type: Opaque
data:
  password: {{ $dragonflyPassword | b64enc | quote }}
{{- end }}

{{- end }}
