{{- if and .Values.dragonfly.enabled .Values.monitoring.serviceMonitor.enabled }}
---
# DragonflyDB ServiceMonitor for Prometheus
# Uses our custom metrics service that exposes the admin port (9999)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ include "dependency-control.fullname" . }}-dragonfly
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
    app.kubernetes.io/component: cache
spec:
  selector:
    matchLabels:
      {{- include "dependency-control.labels" . | nindent 6 }}
      app.kubernetes.io/component: cache-metrics
  endpoints:
    - port: admin
      path: /metrics
      interval: {{ .Values.monitoring.serviceMonitor.interval | default "30s" }}
      scrapeTimeout: {{ .Values.monitoring.serviceMonitor.scrapeTimeout | default "10s" }}
      {{- if .Values.global.tls.enabled }}
      scheme: https
      tlsConfig:
        # Skip server certificate verification (Prometheus connects to pod IPs)
        insecureSkipVerify: true
        # Provide client certificate for mTLS authentication
        cert:
          secret:
            name: {{ .Release.Name }}-dragonfly-tls
            key: tls.crt
        keySecret:
          name: {{ .Release.Name }}-dragonfly-tls
          key: tls.key
      {{- else }}
      scheme: http
      {{- end }}
{{- end }}
