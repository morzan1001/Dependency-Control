{{- if .Values.networkPolicy.enabled }}
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-default-deny
  labels:
    {{- include "dependency-control.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
# Allow Backend to talk to MongoDB
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-backend-to-mongo
spec:
  podSelector:
    matchLabels:
      {{- include "dependency-control.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          {{- if eq .Values.database.type "mongodb" }}
          app: "{{ .Values.database.cluster.name }}-svc"
          {{- else }}
          app.kubernetes.io/instance: {{ .Values.database.cluster.name }}
          app.kubernetes.io/name: percona-server-mongodb
          {{- end }}
    ports:
    - protocol: TCP
      port: 27017

---
# Allow Backend to talk to Internet (for Scanners & Updates)
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-backend-egress-internet
spec:
  podSelector:
    matchLabels:
      {{- include "dependency-control.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Egress
  egress:
  - ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80
    # Allow SMTP
    - protocol: TCP
      port: 25
    - protocol: TCP
      port: 465
    - protocol: TCP
      port: 587
  # Allow DNS resolution
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Allow Ingress to Backend
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-ingress-to-backend
spec:
  podSelector:
    matchLabels:
      {{- include "dependency-control.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: backend
  policyTypes:
  - Ingress
  ingress:
  {{- range .Values.networkPolicy.ingress }}
  - from:
{{ toYaml .from | indent 4 }}
    ports:
    - protocol: TCP
      {{- if $.Values.global.tls.enabled }}
      port: 8443
      {{- else }}
      port: 8000
      {{- end }}
  {{- end }}
  {{- if .Values.monitoring.serviceMonitor.enabled }}
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      {{- if .Values.global.tls.enabled }}
      port: 8443
      {{- else }}
      port: 8000
      {{- end }}
  {{- end }}
{{- end }}

{{- if .Values.networkPolicy.enabled }}
---
# Allow Ingress to Frontend
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-ingress-to-frontend
spec:
  podSelector:
    matchLabels:
      {{- include "dependency-control.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: frontend
  policyTypes:
  - Ingress
  ingress:
  {{- range .Values.networkPolicy.ingress }}
  - from:
{{ toYaml .from | indent 4 }}
    ports:
    - protocol: TCP
      {{- if $.Values.global.tls.enabled }}
      port: 443
      {{- else }}
      port: 80
      {{- end }}
  {{- end }}
{{- end }}

{{- if .Values.networkPolicy.enabled }}
---
# Allow MongoDB to receive traffic from Backend, Operator, and other Mongo nodes
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-mongo-ingress
spec:
  podSelector:
    matchLabels:
      {{- if eq .Values.database.type "mongodb" }}
      app: "{{ .Values.database.cluster.name }}-svc"
      {{- else }}
      app.kubernetes.io/instance: {{ .Values.database.cluster.name }}
      app.kubernetes.io/name: percona-server-mongodb
      {{- end }}
  policyTypes:
  - Ingress
  ingress:
  - from:
    # Allow Backend
    - podSelector:
        matchLabels:
          {{- include "dependency-control.selectorLabels" . | nindent 10 }}
    # Allow other Mongo nodes (Replication)
    - podSelector:
        matchLabels:
          {{- if eq .Values.database.type "mongodb" }}
          app: "{{ .Values.database.cluster.name }}-svc"
          {{- else }}
          app.kubernetes.io/instance: {{ .Values.database.cluster.name }}
          app.kubernetes.io/name: percona-server-mongodb
          {{- end }}
    # Allow Operator
    - podSelector:
        matchLabels:
          {{- if eq .Values.database.type "mongodb" }}
          app.kubernetes.io/name: mongodb-kubernetes-operator
          {{- else }}
          app.kubernetes.io/name: percona-server-mongodb-operator
          {{- end }}
    ports:
    - protocol: TCP
      port: 27017

---
# Allow MongoDB to talk to other Mongo nodes (Replication)
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-mongo-egress
spec:
  podSelector:
    matchLabels:
      {{- if eq .Values.database.type "mongodb" }}
      app: "{{ .Values.database.cluster.name }}-svc"
      {{- else }}
      app.kubernetes.io/instance: {{ .Values.database.cluster.name }}
      app.kubernetes.io/name: percona-server-mongodb
      {{- end }}
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          {{- if eq .Values.database.type "mongodb" }}
          app: "{{ .Values.database.cluster.name }}-svc"
          {{- else }}
          app.kubernetes.io/instance: {{ .Values.database.cluster.name }}
          app.kubernetes.io/name: percona-server-mongodb
          {{- end }}
    ports:
    - protocol: TCP
      port: 27017
  # Allow DNS
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow K8s API
  - ports:
    - protocol: TCP
      port: 443

---
# Allow Operator to talk to K8s API and MongoDB
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-operator-egress
spec:
  podSelector:
    matchLabels:
      {{- if eq .Values.database.type "mongodb" }}
      app.kubernetes.io/name: mongodb-kubernetes-operator
      {{- else }}
      app.kubernetes.io/name: percona-server-mongodb-operator
      {{- end }}
  policyTypes:
  - Egress
  egress:
  # Allow everything for Operator to ensure it can manage resources and talk to K8s API
  - {}
{{- end }}

{{- if and .Values.dragonfly.enabled .Values.networkPolicy.enabled }}
---
# Allow Backend to talk to DragonflyDB (Subchart)
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-backend-to-dragonfly
spec:
  podSelector:
    matchLabels:
      {{- include "dependency-control.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: backend
  policyTypes:
  - Egress
  egress:
  - to:
    # DragonflyDB subchart pods use app.kubernetes.io/name: dragonfly
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: dragonfly
          app.kubernetes.io/instance: {{ .Release.Name }}
    ports:
    - protocol: TCP
      port: 6379

---
# Allow DragonflyDB to receive traffic from Backend only
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-dragonfly-ingress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dragonfly
      app.kubernetes.io/instance: {{ .Release.Name }}
  policyTypes:
  - Ingress
  ingress:
  # Allow from Backend pods only
  - from:
    - podSelector:
        matchLabels:
          {{- include "dependency-control.selectorLabels" . | nindent 10 }}
          app.kubernetes.io/component: backend
    ports:
    - protocol: TCP
      port: 6379
  # Allow from other DragonflyDB pods (for potential replication)
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: dragonfly
          app.kubernetes.io/instance: {{ .Release.Name }}
    ports:
    - protocol: TCP
      port: 6379
  {{- if .Values.dragonfly.serviceMonitor.enabled }}
  # Allow Prometheus to scrape metrics
  - from:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: prometheus
    ports:
    - protocol: TCP
      port: 9999
  {{- end }}

---
# Allow DragonflyDB pods minimal egress (DNS only)
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: {{ include "dependency-control.fullname" . }}-dragonfly-egress
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dragonfly
      app.kubernetes.io/instance: {{ .Release.Name }}
  policyTypes:
  - Egress
  egress:
  # Allow communication between DragonflyDB pods (for potential replication)
  - to:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: dragonfly
          app.kubernetes.io/instance: {{ .Release.Name }}
    ports:
    - protocol: TCP
      port: 6379
  # Allow DNS resolution only
  - ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
{{- end }}
