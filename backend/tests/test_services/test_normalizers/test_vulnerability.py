"""Tests for vulnerability normalizers (Trivy, Grype, OSV).

Tests verify correct normalization behavior. If tests fail,
the normalizer code should be investigated for bugs.
"""

from app.services.aggregator import ResultAggregator


class TestNormalizeTrivy:
    """Tests for normalize_trivy - normalizes Trivy scanner output."""

    def setup_method(self):
        self.agg = ResultAggregator()

    def _trivy_result(self, vulns):
        return {"Results": [{"Target": "test", "Vulnerabilities": vulns}]}

    def test_basic_vuln(self):
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-2023-1234",
                    "PkgName": "requests",
                    "InstalledVersion": "2.28.0",
                    "Severity": "HIGH",
                    "Description": "A vulnerability",
                    "FixedVersion": "2.28.1",
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        findings = self.agg.get_findings()
        assert len(findings) == 1
        f = findings[0]
        assert f.type == "vulnerability"
        assert f.component == "requests"
        assert f.version == "2.28.0"
        assert f.severity == "HIGH"
        vulns = f.details["vulnerabilities"]
        assert vulns[0]["id"] == "CVE-2023-1234"
        assert vulns[0]["fixed_version"] == "2.28.1"

    def test_no_results_key_skipped(self):
        self.agg.aggregate("trivy", {"other": "data"})
        assert len(self.agg.findings) == 0

    def test_empty_vulnerabilities_skipped(self):
        self.agg.aggregate("trivy", {"Results": [{"Vulnerabilities": []}]})
        assert len(self.agg.findings) == 0

    def test_null_vulnerabilities_skipped(self):
        self.agg.aggregate("trivy", {"Results": [{"Vulnerabilities": None}]})
        assert len(self.agg.findings) == 0

    def test_ghsa_id_normalized_to_cve(self):
        """If a GHSA ID has a CVE alias in references, CVE should become primary ID."""
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "GHSA-xxxx-yyyy-zzzz",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Description": "test",
                    "References": ["https://nvd.nist.gov/vuln/detail/CVE-2023-9999"],
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        findings = self.agg.get_findings()
        vulns = findings[0].details["vulnerabilities"]
        # CVE should be the primary ID
        assert vulns[0]["id"] == "CVE-2023-9999"
        # GHSA should be an alias
        assert "GHSA-xxxx-yyyy-zzzz" in vulns[0]["aliases"]

    def test_cvss_extracted(self):
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "CRITICAL",
                    "Description": "test",
                    "CVSS": {"nvd": {"V3Score": 9.8, "V3Vector": "CVSS:3.1/AV:N"}},
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["cvss_score"] == 9.8
        assert vulns[0]["cvss_vector"] == "CVSS:3.1/AV:N"

    def test_cwe_ids_passed(self):
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Description": "test",
                    "CweIDs": ["CWE-79", "CWE-89"],
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["details"]["cwe_ids"] == ["CWE-79", "CWE-89"]

    def test_title_and_description_merged(self):
        """When title is not a substring of description, both should be present."""
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Title": "SQL Injection",
                    "Description": "A serious vulnerability in the query parser.",
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        desc = vulns[0]["description"]
        assert "SQL Injection" in desc
        assert "query parser" in desc

    def test_title_redundant_with_description(self):
        """When title is a substring of description, only description used."""
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Title": "A serious vulnerability",
                    "Description": "A serious vulnerability in the query parser.",
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        desc = vulns[0]["description"]
        # Should only be the description, not duplicated
        assert desc == "A serious vulnerability in the query parser."

    def test_scanner_is_trivy(self):
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Description": "test",
                }
            ]
        )
        self.agg.aggregate("trivy", result)
        f = list(self.agg.findings.values())[0]
        assert "trivy" in f.scanners

    def test_source_passed_through(self):
        result = self._trivy_result(
            [
                {
                    "VulnerabilityID": "CVE-1",
                    "PkgName": "pkg",
                    "InstalledVersion": "1.0",
                    "Severity": "HIGH",
                    "Description": "test",
                }
            ]
        )
        self.agg.aggregate("trivy", result, source="sbom.json")
        f = list(self.agg.findings.values())[0]
        assert "sbom.json" in f.found_in


class TestNormalizeGrype:
    """Tests for normalize_grype - normalizes Grype scanner output."""

    def setup_method(self):
        self.agg = ResultAggregator()

    def _grype_result(self, matches):
        return {"matches": matches}

    def test_basic_vuln(self):
        result = self._grype_result(
            [
                {
                    "vulnerability": {
                        "id": "CVE-2023-5678",
                        "severity": "CRITICAL",
                        "description": "Bad bug",
                        "fix": {"versions": ["1.2.3"]},
                    },
                    "artifact": {"name": "express", "version": "4.17.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        findings = self.agg.get_findings()
        assert len(findings) == 1
        f = findings[0]
        assert f.component == "express"
        assert f.severity == "CRITICAL"

    def test_ghsa_normalized_to_cve(self):
        """GHSA ID with CVE in relatedVulnerabilities should be normalized."""
        result = self._grype_result(
            [
                {
                    "vulnerability": {
                        "id": "GHSA-test-1234",
                        "severity": "HIGH",
                        "description": "test",
                        "relatedVulnerabilities": [{"id": "CVE-2023-9999"}],
                    },
                    "artifact": {"name": "pkg", "version": "1.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["id"] == "CVE-2023-9999"
        assert "GHSA-test-1234" in vulns[0]["aliases"]

    def test_fix_versions_joined(self):
        result = self._grype_result(
            [
                {
                    "vulnerability": {
                        "id": "CVE-1",
                        "severity": "HIGH",
                        "description": "test",
                        "fix": {"versions": ["1.2.3", "2.0.0"]},
                    },
                    "artifact": {"name": "pkg", "version": "1.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["fixed_version"] == "1.2.3, 2.0.0"

    def test_no_fix_versions(self):
        result = self._grype_result(
            [
                {
                    "vulnerability": {
                        "id": "CVE-1",
                        "severity": "HIGH",
                        "description": "test",
                        "fix": {"versions": []},
                    },
                    "artifact": {"name": "pkg", "version": "1.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["fixed_version"] is None

    def test_cvss_extracted(self):
        result = self._grype_result(
            [
                {
                    "vulnerability": {
                        "id": "CVE-1",
                        "severity": "HIGH",
                        "description": "test",
                        "cvss": [{"version": "3.1", "metrics": {"baseScore": 8.5}, "vector": "V31"}],
                    },
                    "artifact": {"name": "pkg", "version": "1.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["cvss_score"] == 8.5

    def test_empty_matches(self):
        self.agg.aggregate("grype", {"matches": []})
        assert len(self.agg.findings) == 0

    def test_scanner_is_grype(self):
        result = self._grype_result(
            [
                {
                    "vulnerability": {"id": "CVE-1", "severity": "HIGH", "description": "test"},
                    "artifact": {"name": "pkg", "version": "1.0"},
                }
            ]
        )
        self.agg.aggregate("grype", result)
        f = list(self.agg.findings.values())[0]
        assert "grype" in f.scanners


class TestNormalizeOsv:
    """Tests for normalize_osv - normalizes OSV scanner output."""

    def setup_method(self):
        self.agg = ResultAggregator()

    def _osv_result(self, items):
        return {"osv_vulnerabilities": items}

    def test_basic_vuln(self):
        result = self._osv_result(
            [
                {
                    "component": "flask",
                    "version": "2.0.0",
                    "vulnerabilities": [
                        {
                            "id": "CVE-2023-1111",
                            "summary": "Flask XSS",
                            "database_specific": {"severity": "HIGH"},
                            "affected": [{"ranges": [{"events": [{"fixed": "2.0.1"}]}]}],
                        }
                    ],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        findings = self.agg.get_findings()
        assert len(findings) == 1
        f = findings[0]
        assert f.component == "flask"
        vulns = f.details["vulnerabilities"]
        assert vulns[0]["id"] == "CVE-2023-1111"
        assert vulns[0]["fixed_version"] == "2.0.1"

    def test_ghsa_to_cve_normalization(self):
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [
                        {
                            "id": "GHSA-abcd-1234-efgh",
                            "summary": "test",
                            "aliases": ["CVE-2023-5555"],
                        }
                    ],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["id"] == "CVE-2023-5555"
        assert "GHSA-abcd-1234-efgh" in vulns[0]["aliases"]

    def test_malware_entry_creates_malware_finding(self):
        """MAL- prefixed IDs should become MALWARE type, not vulnerability."""
        result = self._osv_result(
            [
                {
                    "component": "evil-pkg",
                    "version": "1.0.0",
                    "vulnerabilities": [
                        {
                            "id": "MAL-2023-1234",
                            "summary": "Malicious package",
                            "affected": [{"versions": ["1.0.0"]}],
                            "references": [{"url": "https://osv.dev/MAL-2023-1234"}],
                        }
                    ],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        findings = self.agg.get_findings()
        assert len(findings) == 1
        f = findings[0]
        assert f.type == "malware"
        assert f.severity == "CRITICAL"
        assert "evil-pkg" in f.component

    def test_debian_cve_prefix_normalized(self):
        """DEBIAN-CVE-2025-10148 should be normalized to CVE-2025-10148."""
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [
                        {
                            "id": "DEBIAN-CVE-2025-10148",
                            "summary": "test",
                        }
                    ],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["id"] == "CVE-2025-10148"
        assert "DEBIAN-CVE-2025-10148" in vulns[0]["aliases"]

    def test_severity_from_database_specific(self):
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [
                        {
                            "id": "CVE-1",
                            "summary": "test",
                            "database_specific": {"severity": "CRITICAL"},
                        }
                    ],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["severity"] == "CRITICAL"

    def test_no_severity_defaults_to_unknown(self):
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [{"id": "CVE-1", "summary": "test"}],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert vulns[0]["severity"] == "UNKNOWN"

    def test_empty_osv_vulnerabilities(self):
        self.agg.aggregate("osv", {"osv_vulnerabilities": []})
        assert len(self.agg.findings) == 0

    def test_scanner_is_osv(self):
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [{"id": "CVE-1", "summary": "test"}],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        f = list(self.agg.findings.values())[0]
        assert "osv" in f.scanners

    def test_osv_url_generated(self):
        result = self._osv_result(
            [
                {
                    "component": "pkg",
                    "version": "1.0",
                    "vulnerabilities": [{"id": "GHSA-1234", "summary": "test"}],
                }
            ]
        )
        self.agg.aggregate("osv", result)
        vulns = list(self.agg.findings.values())[0].details["vulnerabilities"]
        assert "osv.dev/vulnerability/GHSA-1234" in vulns[0]["details"].get("osv_url", "")
