import httpx
import asyncio
from typing import Dict, Any, List
from app.core.config import settings
from .base import Analyzer

class OpenSourceMalwareAnalyzer(Analyzer):
    name = "os_malware"
    api_url = "https://api.opensourcemalware.com/functions/v1/check-package"

    async def analyze(self, sbom: Dict[str, Any]) -> Dict[str, Any]:
        if not settings.OPEN_SOURCE_MALWARE_API_KEY:
            print("Skipping OpenSourceMalware analysis: API Key not configured.")
            return {"error": "API Key not configured"}

        components = sbom.get("components", [])
        results = []
        
        async with httpx.AsyncClient() as client:
            tasks = []
            for component in components:
                tasks.append(self._check_component(client, component))
            
            # Run checks concurrently
            component_results = await asyncio.gather(*tasks)
            
            # Filter out None results (clean components or errors)
            results = [r for r in component_results if r]

        return {"malware_issues": results}

    async def _check_component(self, client: httpx.AsyncClient, component: Dict[str, Any]) -> Dict[str, Any]:
        name = component.get("name", "")
        version = component.get("version", "")
        purl = component.get("purl", "")
        
        # Determine registry from purl or type
        registry = "unknown"
        if purl.startswith("pkg:pypi/"):
            registry = "pypi"
        elif purl.startswith("pkg:npm/"):
            registry = "npm"
        elif purl.startswith("pkg:maven/"):
            registry = "maven"
        # Add more mappings as needed
        
        if registry == "unknown":
            # Try to guess from component type if available
            comp_type = component.get("type", "")
            if comp_type == "python":
                registry = "pypi"
            elif comp_type == "npm":
                registry = "npm"
            elif comp_type == "java-archive": # Syft often uses this for maven
                registry = "maven"

        if not name or registry == "unknown":
            return None

        try:
            payload = {
                "package_name": name,
                "registry": registry,
                "version": version
            }
            headers = {
                "Authorization": f"Bearer {settings.OPEN_SOURCE_MALWARE_API_KEY}",
                "Content-Type": "application/json"
            }
            
            response = await client.post(self.api_url, json=payload, headers=headers)
            
            if response.status_code == 200:
                data = response.json()
                # Assuming the API returns something like {"malicious": true, ...} or a list of threats
                # Adjust this logic based on actual API response structure
                if data.get("malicious") or data.get("threats"):
                     return {
                        "component": name,
                        "version": version,
                        "registry": registry,
                        "malware_info": data
                    }
            elif response.status_code == 404:
                # Package not found in malware db -> likely safe
                pass
            else:
                print(f"Error checking {name} ({registry}): {response.status_code} - {response.text}")

        except Exception as e:
            print(f"Exception checking {name}: {e}")
        
        return None
