{% extends "base.html" %}

{% block title %}Security Alert: Vulnerabilities Found{% endblock %}

{% block content %}
{% if has_kev %}
<div class="alert alert-danger" style="background-color: #dc2626; color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <strong>‚ö†Ô∏è CRITICAL: Known Exploited Vulnerabilities Detected</strong>
    <p style="margin-top: 8px; font-size: 14px;">{{ kev_count }} vulnerabilit{{ 'y is' if kev_count == 1 else 'ies are' }} actively being exploited in the wild according to CISA KEV catalog.</p>
</div>
{% endif %}

{% if has_high_epss %}
<div class="alert alert-warning" style="background-color: #f59e0b; color: black; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <strong>üéØ High Exploitation Probability</strong>
    <p style="margin-top: 8px; font-size: 14px;">{{ high_epss_count }} vulnerabilit{{ 'y has' if high_epss_count == 1 else 'ies have' }} an EPSS score above 10%, indicating high likelihood of exploitation.</p>
</div>
{% endif %}

<div class="alert alert-danger" style="background-color: #fee2e2; border: 1px solid #fecaca; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
    <strong>üî¥ Security Alert:</strong> Vulnerabilities found in {{ project_name_scanned }}
</div>

<h3 style="margin-top: 24px;">Scan Summary</h3>
<p>A recent scan of <strong>{{ project_name_scanned }}</strong> has detected the following issues:</p>

<table style="width: 100%; border-collapse: collapse; margin: 16px 0;">
    <thead>
        <tr style="background-color: #f3f4f6;">
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">ID</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Severity</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Package</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Flags</th>
        </tr>
    </thead>
    <tbody>
        {% for vuln in vulnerabilities %}
        <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px;">
                <strong>{{ vuln.id }}</strong>
            </td>
            <td style="padding: 12px;">
                {% if vuln.severity == 'CRITICAL' %}
                <span style="background-color: #dc2626; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">CRITICAL</span>
                {% elif vuln.severity == 'HIGH' %}
                <span style="background-color: #ea580c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">HIGH</span>
                {% elif vuln.severity == 'MEDIUM' %}
                <span style="background-color: #ca8a04; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">MEDIUM</span>
                {% else %}
                <span style="background-color: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ vuln.severity }}</span>
                {% endif %}
            </td>
            <td style="padding: 12px;">
                {{ vuln.package }} <span style="color: #6b7280;">{{ vuln.version }}</span>
            </td>
            <td style="padding: 12px;">
                {% if vuln.in_kev %}
                <span style="background-color: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;">KEV</span>
                {% endif %}
                {% if vuln.epss_score and vuln.epss_score >= 0.1 %}
                <span style="background-color: #f59e0b; color: black; padding: 2px 6px; border-radius: 4px; font-size: 11px;">EPSS: {{ (vuln.epss_score * 100)|round(1) }}%</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if kev_vulnerabilities %}
<h3 style="margin-top: 24px; color: #dc2626;">‚ö†Ô∏è Known Exploited Vulnerabilities (KEV)</h3>
<p style="color: #6b7280; font-size: 14px;">These vulnerabilities are in CISA's Known Exploited Vulnerabilities catalog and require immediate attention:</p>
<ul style="margin: 16px 0;">
    {% for vuln in kev_vulnerabilities %}
    <li style="margin: 8px 0;">
        <strong>{{ vuln.id }}</strong> - {{ vuln.package }} {{ vuln.version }}
        {% if vuln.kev_due_date %}
        <br><span style="color: #dc2626; font-size: 13px;">Remediation due: {{ vuln.kev_due_date }}</span>
        {% endif %}
        {% if vuln.kev_ransomware_use %}
        <br><span style="background-color: #7c3aed; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Used in Ransomware</span>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

<p style="margin-top: 24px;"><strong>Please review these findings immediately.</strong></p>

<div style="text-align: center; margin-top: 24px;">
    <a href="{{ link }}" class="button" style="background-color: #dc2626; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold;">View Full Report</a>
</div>
{% endblock %}
