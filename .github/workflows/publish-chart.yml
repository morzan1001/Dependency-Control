name: Publish Helm Chart

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*' ]
    paths:
      - 'helm/**'
      - '.github/workflows/publish-chart.yml'

env:
  REGISTRY: ghcr.io

jobs:
  publish-chart:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Chart Dependencies
        run: |
          cd "helm/dependency-control"
          helm dependency update

      - name: Lint Chart
        run: |
          cd "helm/dependency-control"
          helm lint .

      - name: Render Chart (Template Check)
        run: |
          cd "helm/dependency-control"
          # Renders the chart locally to verify templates are valid
          helm template . > /dev/null

      - name: Package Chart
        run: |
          cd "helm/dependency-control"
          helm package .

      - name: Push Chart to GHCR
        run: |
          cd "helm/dependency-control"
          # Convert owner to lowercase
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # Pushes the chart as an OCI artifact to GitHub Container Registry
          helm push dependency-control-*.tgz oci://${{ env.REGISTRY }}/${OWNER_LOWER}/charts
          helm push $(ls *.tgz) oci://${{ env.REGISTRY }}/${{ github.repository_owner }}
