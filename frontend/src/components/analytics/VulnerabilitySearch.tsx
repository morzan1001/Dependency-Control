import { useState, useEffect } from 'react'
import { useInfiniteQuery, useQuery, keepPreviousData } from '@tanstack/react-query'
import { useVirtualizer } from '@tanstack/react-virtual'
import { analyticsApi } from '@/api/analytics'
import { VulnerabilitySearchResult, Severity } from '@/types/analytics'
import { projectApi } from '@/api/projects'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Table, TableBody, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Skeleton } from '@/components/ui/skeleton'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Label } from '@/components/ui/label'
import { Checkbox } from '@/components/ui/checkbox'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"
import { 
  Search, 
  Filter, 
  X, 
  Loader2, 
  ShieldAlert, 
  AlertTriangle, 
  ExternalLink,
  CheckCircle,
  XCircle
} from 'lucide-react'
import { Link } from 'react-router-dom'
import { useDebounce } from '@/hooks/use-debounce'
import { DEFAULT_PAGE_SIZE, VIRTUAL_SCROLL_OVERSCAN } from '@/lib/constants'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"
import { useScrollContainer, createScrollObserver } from '@/hooks/use-scroll-container'
import { formatDate } from '@/lib/utils'

const severityColors: Record<Severity, string> = {
  CRITICAL: 'bg-red-600 text-white',
  HIGH: 'bg-orange-500 text-white',
  MEDIUM: 'bg-yellow-500 text-black',
  LOW: 'bg-blue-500 text-white',
  INFO: 'bg-gray-400 text-white',
  UNKNOWN: 'bg-gray-300 text-gray-700',
  NEGLIGIBLE: 'bg-gray-200 text-gray-600',
}

export function VulnerabilitySearch() {
  const [query, setQuery] = useState('')
  const [severity, setSeverity] = useState<string>('__all__')
  const [inKev, setInKev] = useState<string>('__all__')
  const [hasFix, setHasFix] = useState<string>('__all__')
  const [selectedProject, setSelectedProject] = useState<string>('__all__')
  const [includeWaived, setIncludeWaived] = useState(false)
  const [showFilters, setShowFilters] = useState(false)

  const { parentRef, scrollContainer, tableOffset } = useScrollContainer()
  const debouncedQuery = useDebounce(query, 300)

  const { data: projectsData } = useQuery({
    queryKey: ['projects-list'],
    queryFn: () => projectApi.getAll(undefined, 0, 100),
  })

  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    isLoading
  } = useInfiniteQuery({
    queryKey: ['vulnerability-search', debouncedQuery, severity, inKev, hasFix, selectedProject, includeWaived],
    queryFn: async ({ pageParam = 0 }) => {
      return analyticsApi.searchVulnerabilities(debouncedQuery, {
        severity: severity !== '__all__' ? severity : undefined,
        in_kev: inKev === '__all__' ? undefined : inKev === 'true',
        has_fix: hasFix === '__all__' ? undefined : hasFix === 'true',
        project_ids: selectedProject !== '__all__' ? [selectedProject] : undefined,
        include_waived: includeWaived,
        skip: pageParam,
        limit: DEFAULT_PAGE_SIZE,
        sort_by: 'severity',
        sort_order: 'desc',
      })
    },
    initialPageParam: 0,
    getNextPageParam: (lastPage) => {
      const nextSkip = (lastPage.page + 1) * lastPage.size
      return nextSkip < lastPage.total ? nextSkip : undefined
    },
    placeholderData: keepPreviousData,
    enabled: debouncedQuery.length >= 2,
  })

  const allResults = data ? data.pages.flatMap((d) => d.items) : []
  const totalCount = data?.pages[0]?.total ?? 0

  // eslint-disable-next-line react-hooks/incompatible-library
  const rowVirtualizer = useVirtualizer({
    count: hasNextPage ? allResults.length + 1 : allResults.length,
    getScrollElement: () => scrollContainer,
    estimateSize: () => 60,
    overscan: VIRTUAL_SCROLL_OVERSCAN,
    observeElementOffset: createScrollObserver(scrollContainer, tableOffset),
  })

  const virtualItems = rowVirtualizer.getVirtualItems()
  const lastItemIndex = virtualItems.length > 0 ? virtualItems[virtualItems.length - 1]?.index : -1

  useEffect(() => {
    if (lastItemIndex === -1) return
    if (lastItemIndex >= allResults.length - 1 && hasNextPage && !isFetchingNextPage) {
      fetchNextPage()
    }
  }, [hasNextPage, fetchNextPage, allResults.length, isFetchingNextPage, lastItemIndex])

  const projects = projectsData?.items || []

  const clearFilters = () => {
    setSeverity('__all__')
    setInKev('__all__')
    setHasFix('__all__')
    setSelectedProject('__all__')
    setIncludeWaived(false)
  }

  const hasActiveFilters = severity !== '__all__' || inKev !== '__all__' || hasFix !== '__all__' || selectedProject !== '__all__' || includeWaived

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle className="flex items-center gap-2">
              <ShieldAlert className="h-5 w-5" />
              Vulnerability Search
            </CardTitle>
            <CardDescription>
              Search for CVEs, GHSAs, and other security identifiers across all projects
            </CardDescription>
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Search Input */}
        <div className="flex gap-2">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search CVE-2021-44228, GHSA-xxx, log4j, etc..."
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              className="pl-10"
            />
          </div>
          <Button
            variant={showFilters ? "secondary" : "outline"}
            onClick={() => setShowFilters(!showFilters)}
            className="gap-2"
          >
            <Filter className="h-4 w-4" />
            Filters
            {hasActiveFilters && (
              <Badge variant="secondary" className="ml-1 h-5 w-5 p-0 justify-center">
                !
              </Badge>
            )}
          </Button>
        </div>

        {/* Filters */}
        {showFilters && (
          <div className="grid grid-cols-2 md:grid-cols-5 gap-4 p-4 bg-muted/50 rounded-lg">
            <div className="space-y-2">
              <Label>Severity</Label>
              <Select value={severity} onValueChange={setSeverity}>
                <SelectTrigger>
                  <SelectValue placeholder="All severities" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="__all__">All Severities</SelectItem>
                  <SelectItem value="CRITICAL">Critical</SelectItem>
                  <SelectItem value="HIGH">High</SelectItem>
                  <SelectItem value="MEDIUM">Medium</SelectItem>
                  <SelectItem value="LOW">Low</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>CISA KEV</Label>
              <Select value={inKev} onValueChange={setInKev}>
                <SelectTrigger>
                  <SelectValue placeholder="All" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="__all__">All</SelectItem>
                  <SelectItem value="true">In KEV</SelectItem>
                  <SelectItem value="false">Not in KEV</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>Fix Available</Label>
              <Select value={hasFix} onValueChange={setHasFix}>
                <SelectTrigger>
                  <SelectValue placeholder="All" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="__all__">All</SelectItem>
                  <SelectItem value="true">Has Fix</SelectItem>
                  <SelectItem value="false">No Fix</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>Project</Label>
              <Select value={selectedProject} onValueChange={setSelectedProject}>
                <SelectTrigger>
                  <SelectValue placeholder="All projects" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="__all__">All Projects</SelectItem>
                  {projects.map((project) => (
                    <SelectItem key={project.id} value={project.id}>
                      {project.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label>&nbsp;</Label>
              <div className="flex items-center gap-4">
                <div className="flex items-center space-x-2">
                  <Checkbox
                    id="include-waived"
                    checked={includeWaived}
                    onCheckedChange={(checked) => setIncludeWaived(checked === true)}
                  />
                  <label htmlFor="include-waived" className="text-sm cursor-pointer">
                    Include waived
                  </label>
                </div>
                {hasActiveFilters && (
                  <Button variant="ghost" size="sm" onClick={clearFilters} className="gap-1">
                    <X className="h-3 w-3" />
                    Clear
                  </Button>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Results */}
        <div ref={parentRef}>
          {query.length < 2 ? (
            <div className="text-center py-12 text-muted-foreground">
              <ShieldAlert className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>Enter at least 2 characters to search for vulnerabilities</p>
              <p className="text-sm mt-2">Examples: CVE-2021-44228, GHSA-jfh8-c2jp-5v3q, log4shell</p>
            </div>
          ) : isLoading ? (
            <div className="space-y-2">
              {[...new Array(5)].map((_, i) => (
                <Skeleton key={i} className="h-14 w-full" />
              ))}
            </div>
          ) : allResults.length === 0 ? (
            <div className="text-center py-12 text-muted-foreground">
              <Search className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>No vulnerabilities found matching "{debouncedQuery}"</p>
            </div>
          ) : (
            <>
              <div className="flex items-center justify-between mb-2">
                <p className="text-sm text-muted-foreground">
                  Found {totalCount.toLocaleString()} result{totalCount !== 1 ? 's' : ''}
                </p>
              </div>
              
              <div className="border rounded-lg overflow-hidden">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="w-[200px]">Vulnerability</TableHead>
                      <TableHead className="w-[100px]">Severity</TableHead>
                      <TableHead>Component</TableHead>
                      <TableHead>Project</TableHead>
                      <TableHead className="w-[100px]">Indicators</TableHead>
                      <TableHead className="w-[120px]">Fix</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    <tr>
                      <td colSpan={6} className="p-0">
                        <div
                          style={{
                            height: `${rowVirtualizer.getTotalSize()}px`,
                            position: 'relative',
                          }}
                        >
                          {virtualItems.map((virtualRow) => {
                            const isLoaderRow = virtualRow.index >= allResults.length
                            const result = allResults[virtualRow.index]

                            if (isLoaderRow) {
                              return (
                                <div
                                  key="loader"
                                  className="absolute left-0 right-0 flex items-center justify-center py-4"
                                  style={{
                                    top: `${virtualRow.start}px`,
                                    height: `${virtualRow.size}px`,
                                  }}
                                >
                                  <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />
                                </div>
                              )
                            }

                            return (
                              <VulnerabilityResultRow
                                key={`${result.vulnerability_id}-${result.project_id}-${virtualRow.index}`}
                                result={result}
                                style={{
                                  position: 'absolute',
                                  top: `${virtualRow.start}px`,
                                  left: 0,
                                  right: 0,
                                  height: `${virtualRow.size}px`,
                                }}
                              />
                            )
                          })}
                        </div>
                      </td>
                    </tr>
                  </TableBody>
                </Table>
              </div>

              {isFetchingNextPage && (
                <div className="flex justify-center py-4">
                  <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                </div>
              )}
            </>
          )}
        </div>
      </CardContent>
    </Card>
  )
}

interface VulnerabilityResultRowProps {
  result: VulnerabilitySearchResult
  style: React.CSSProperties
}

function VulnerabilityResultRow({ result, style }: VulnerabilityResultRowProps) {
  return (
    <div
      className="flex items-center border-b hover:bg-muted/50 transition-colors"
      style={style}
    >
      {/* Vulnerability ID */}
      <div className="w-[200px] px-4 py-2">
        <div className="font-mono text-sm font-medium">
          {result.vulnerability_id.startsWith('CVE-') ? (
            <a
              href={`https://nvd.nist.gov/vuln/detail/${result.vulnerability_id}`}
              target="_blank"
              rel="noopener noreferrer"
              className="text-primary hover:underline flex items-center gap-1"
            >
              {result.vulnerability_id}
              <ExternalLink className="h-3 w-3" />
            </a>
          ) : result.vulnerability_id.startsWith('GHSA-') ? (
            <a
              href={`https://github.com/advisories/${result.vulnerability_id}`}
              target="_blank"
              rel="noopener noreferrer"
              className="text-primary hover:underline flex items-center gap-1"
            >
              {result.vulnerability_id}
              <ExternalLink className="h-3 w-3" />
            </a>
          ) : (
            result.vulnerability_id
          )}
        </div>
        {result.aliases.length > 0 && (
          <div className="text-xs text-muted-foreground truncate">
            {result.aliases.slice(0, 2).join(', ')}
          </div>
        )}
      </div>

      {/* Severity */}
      <div className="w-[100px] px-4 py-2">
        <Badge className={severityColors[result.severity]}>
          {result.severity}
        </Badge>
        {result.cvss_score && (
          <div className="text-xs text-muted-foreground mt-1">
            CVSS: {result.cvss_score.toFixed(1)}
          </div>
        )}
      </div>

      {/* Component */}
      <div className="flex-1 px-4 py-2 min-w-0">
        <div className="font-medium truncate">{result.component}</div>
        <div className="text-xs text-muted-foreground">
          v{result.version}
          {result.component_type && (
            <span className="ml-2 text-muted-foreground/70">({result.component_type})</span>
          )}
        </div>
      </div>

      {/* Project */}
      <div className="w-[150px] px-4 py-2">
        <Link
          to={`/projects/${result.project_id}`}
          className="text-primary hover:underline text-sm truncate block"
        >
          {result.project_name}
        </Link>
      </div>

      {/* Indicators */}
      <div className="w-[100px] px-4 py-2">
        <div className="flex items-center gap-1">
          <TooltipProvider>
            {result.in_kev && (
              <Tooltip>
                <TooltipTrigger>
                  <Badge variant="destructive" className="text-xs px-1">
                    KEV
                  </Badge>
                </TooltipTrigger>
                <TooltipContent>
                  <p>In CISA Known Exploited Vulnerabilities</p>
                  {result.kev_due_date && (
                    <p className="text-xs">Due: {formatDate(result.kev_due_date)}</p>
                  )}
                </TooltipContent>
              </Tooltip>
            )}
            {result.epss_score && result.epss_score > 0.1 && (
              <Tooltip>
                <TooltipTrigger>
                  <Badge variant="outline" className="text-xs px-1">
                    <AlertTriangle className="h-3 w-3 mr-1" />
                    {(result.epss_score * 100).toFixed(0)}%
                  </Badge>
                </TooltipTrigger>
                <TooltipContent>
                  EPSS Score: {(result.epss_score * 100).toFixed(1)}%
                  {result.epss_percentile && (
                    <span className="ml-1">({result.epss_percentile.toFixed(0)}th percentile)</span>
                  )}
                </TooltipContent>
              </Tooltip>
            )}
            {result.waived && (
              <Tooltip>
                <TooltipTrigger>
                  <Badge variant="secondary" className="text-xs px-1">
                    Waived
                  </Badge>
                </TooltipTrigger>
                <TooltipContent>
                  {result.waiver_reason || 'No reason provided'}
                </TooltipContent>
              </Tooltip>
            )}
          </TooltipProvider>
        </div>
      </div>

      {/* Fix */}
      <div className="w-[120px] px-4 py-2">
        {result.fixed_version ? (
          <div className="flex items-center gap-1 text-green-600">
            <CheckCircle className="h-4 w-4" />
            <span className="text-xs font-mono">{result.fixed_version}</span>
          </div>
        ) : (
          <div className="flex items-center gap-1 text-muted-foreground">
            <XCircle className="h-4 w-4" />
            <span className="text-xs">No fix</span>
          </div>
        )}
      </div>
    </div>
  )
}
