import { useQuery } from '@tanstack/react-query'
import { getVulnerabilityHotspots, VulnerabilityHotspot } from '@/lib/api'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Skeleton } from '@/components/ui/skeleton'
import { Flame, AlertTriangle, Calendar } from 'lucide-react'
import { formatDistanceToNow } from 'date-fns'

interface VulnerabilityHotspotsProps {
  onSelectHotspot?: (hotspot: VulnerabilityHotspot) => void;
}

export function VulnerabilityHotspots({ onSelectHotspot }: VulnerabilityHotspotsProps) {
  const { data: hotspots, isLoading } = useQuery({
    queryKey: ['vulnerability-hotspots'],
    queryFn: () => getVulnerabilityHotspots(20),
  })

  const getHeatColor = (count: number) => {
    if (count >= 10) return 'bg-red-500'
    if (count >= 5) return 'bg-orange-500'
    if (count >= 3) return 'bg-yellow-500'
    return 'bg-blue-500'
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center gap-2">
          <Flame className="h-5 w-5 text-orange-500" />
          <div>
            <CardTitle>Vulnerability Hotspots</CardTitle>
            <CardDescription>
              Dependencies with the highest concentration of vulnerabilities
            </CardDescription>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="space-y-2">
            {Array(5).fill(0).map((_, i) => (
              <Skeleton key={i} className="h-14 w-full" />
            ))}
          </div>
        ) : hotspots && hotspots.length > 0 ? (
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Component</TableHead>
                <TableHead>Version</TableHead>
                <TableHead>Type</TableHead>
                <TableHead className="text-center">Vulnerabilities</TableHead>
                <TableHead>Severity</TableHead>
                <TableHead>Affected Projects</TableHead>
                <TableHead>First Seen</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {hotspots.map((hotspot) => (
                <TableRow 
                  key={`${hotspot.component}-${hotspot.version}`}
                  className={onSelectHotspot ? "cursor-pointer hover:bg-muted" : ""}
                  onClick={() => onSelectHotspot?.(hotspot)}
                >
                  <TableCell>
                    <div className="flex items-center gap-2">
                      <div className={`w-2 h-2 rounded-full ${getHeatColor(hotspot.finding_count)}`} />
                      <span className="font-medium">{hotspot.component}</span>
                    </div>
                  </TableCell>
                  <TableCell>
                    <Badge variant="outline">{hotspot.version}</Badge>
                  </TableCell>
                  <TableCell>
                    <Badge variant="secondary">{hotspot.type}</Badge>
                  </TableCell>
                  <TableCell className="text-center">
                    <div className="flex items-center justify-center gap-1">
                      <AlertTriangle className="h-4 w-4 text-destructive" />
                      <span className="font-bold">{hotspot.finding_count}</span>
                    </div>
                  </TableCell>
                  <TableCell>
                    <div className="flex gap-1 flex-wrap">
                      {hotspot.severity_breakdown.critical > 0 && (
                        <Badge variant="destructive" className="text-xs">
                          C:{hotspot.severity_breakdown.critical}
                        </Badge>
                      )}
                      {hotspot.severity_breakdown.high > 0 && (
                        <Badge className="text-xs bg-orange-500 hover:bg-orange-600">
                          H:{hotspot.severity_breakdown.high}
                        </Badge>
                      )}
                      {hotspot.severity_breakdown.medium > 0 && (
                        <Badge className="text-xs bg-yellow-500 hover:bg-yellow-600 text-black">
                          M:{hotspot.severity_breakdown.medium}
                        </Badge>
                      )}
                      {hotspot.severity_breakdown.low > 0 && (
                        <Badge className="text-xs bg-blue-500 hover:bg-blue-600">
                          L:{hotspot.severity_breakdown.low}
                        </Badge>
                      )}
                    </div>
                  </TableCell>
                  <TableCell>
                    <div className="flex flex-wrap gap-1 max-w-[200px]">
                      {hotspot.affected_projects.slice(0, 2).map((name) => (
                        <Badge key={name} variant="secondary" className="text-xs truncate max-w-[80px]">
                          {name}
                        </Badge>
                      ))}
                      {hotspot.affected_projects.length > 2 && (
                        <Badge variant="secondary" className="text-xs">
                          +{hotspot.affected_projects.length - 2}
                        </Badge>
                      )}
                    </div>
                  </TableCell>
                  <TableCell>
                    {hotspot.first_seen && (
                      <div className="flex items-center gap-1 text-sm text-muted-foreground">
                        <Calendar className="h-3 w-3" />
                        <span>
                          {formatDistanceToNow(new Date(hotspot.first_seen), { addSuffix: true })}
                        </span>
                      </div>
                    )}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        ) : (
          <div className="flex flex-col items-center justify-center py-12 text-muted-foreground">
            <Flame className="h-12 w-12 mb-4" />
            <p>No vulnerability hotspots found</p>
            <p className="text-sm">Your projects appear to be in good shape!</p>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
